name: Build and Release TizenTube WGT

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag name (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-wgt:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Tizen Studio
      uses: actions/cache@v4
      with:
        path: web-cli_Tizen_Studio_5.1_ubuntu-64.bin
        key: tizen-studio-5.1-${{ hashFiles('docker/build-docker.sh') }}

    - name: Download Tizen Studio (if not cached)
      run: |
        if [ ! -f "web-cli_Tizen_Studio_5.1_ubuntu-64.bin" ]; then
          echo "📥 Downloading Tizen Studio..."
          sudo apt-get update && sudo apt-get install -y aria2
          aria2c -j 16 -s 16 -x 16 \
            -o "web-cli_Tizen_Studio_5.1_ubuntu-64.bin" \
            --header='Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8' \
            --header='Accept-Language: en-US,en;q=0.6' \
            --header='Referer: https://developer.tizen.org/' \
            -U 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36' \
            https://download.tizen.org/sdk/Installer/tizen-studio_5.1/web-cli_Tizen_Studio_5.1_ubuntu-64.bin
          chmod +x "web-cli_Tizen_Studio_5.1_ubuntu-64.bin"
        else
          echo "✅ Using cached Tizen Studio"
        fi

    - name: Build Docker image
      run: |
        echo "🔨 Building TizenTube Docker image..."
        docker buildx build --platform linux/amd64 --load -t tizentube-builder .

    - name: Create output and certificates directories
      run: |
        mkdir -p output certificates
        chmod 777 output certificates

    - name: Build WGT using Docker
      run: |
        echo "🚀 Building TizenTube WGT..."
        docker run --platform linux/amd64 --rm \
          -v "$(pwd)/output:/output" \
          -v "$(pwd)/certificates:/tizen/tizen-studio-data/keystore/author" \
          tizentube-builder

    - name: Verify WGT creation
      run: |
        if [ -f "output/TizenTube.wgt" ]; then
          echo "✅ WGT created successfully"
          ls -lah output/TizenTube.wgt
          echo "📊 WGT size: $(stat -c%s output/TizenTube.wgt | numfmt --to=iec)"
        else
          echo "❌ WGT creation failed"
          ls -la output/
          exit 1
        fi

    - name: Generate release notes
      id: release_notes
      run: |
        cat > release_notes.md << EOF
        # TizenTube Standalone Release
        
        ## 🚀 Installation
        
        ### Quick Install (Recommended)
        1. Download \`TizenTube.wgt\` from this release
        2. Copy to USB drive and install on your Samsung TV
        3. Launch TizenTube from your TV's app menu
        
        ### Developer Install
        \`\`\`bash
        # Connect to your TV and install directly
        tizen install -t 0 -n TizenTube.wgt
        \`\`\`
        
        ## ✨ Features
        - **Ad-free YouTube TV** - Complete ad blocking
        - **SponsorBlock integration** - Skip sponsored segments
        - **Speed controls** - Adjust playback speed
        - **Custom themes** - Personalize your experience  
        - **Long press support** - Enhanced navigation
        - **No TizenBrew required** - Direct TV installation
        
        ## 🔧 Technical Details
        - **App ID**: \`com.tizentube.standalone\`
        - **Min Tizen Version**: 6.0+
        - **Compatible**: Samsung Tizen TVs (2018+)
        - **Size**: $(stat -c%s output/TizenTube.wgt | numfmt --to=iec)
        - **Build**: GitHub Actions automated build
        
        ## 🛠️ Build from Source
        \`\`\`bash
        git clone https://github.com/reisxd/TizenTube.git
        cd TizenTube
        ./docker/build-docker.sh
        \`\`\`
        
        ## 💬 Support
        - [Discord Community](https://discord.gg/m2P7v8Y2qR)
        - [GitHub Issues](https://github.com/reisxd/TizenTube/issues)
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.tag_name || github.ref_name }}
        name: TizenTube Standalone ${{ github.event.inputs.tag_name || github.ref_name }}
        body_path: release_notes.md
        files: |
          output/TizenTube.wgt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tizentube-wgt-${{ github.event.inputs.tag_name || github.ref_name }}
        path: output/TizenTube.wgt
        retention-days: 30